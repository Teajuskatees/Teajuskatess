<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Keuangan Cash & Saldo</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      min-height: 100vh;
      display: flex; justify-content: center; align-items: center;
    }
    .container {
      background: #fff; padding: 20px; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      width: 95%; max-width: 700px;
      margin-bottom: 60px;
    }
    h2 { text-align: center; margin-bottom: 20px; color: #333; }
    form { display: flex; flex-direction: column; gap: 10px; }
    input, select, button {
      padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;
    }
    button {
      background: #4facfe; border: none; color: white; font-weight: bold;
      cursor: pointer; transition: 0.3s;
    }
    button:hover { background: #00c6ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
    th { background: #f4f4f4; }
    .income { color: green; font-weight: bold; }
    .expense { color: red; font-weight: bold; }
    .saldo-box { margin-top: 15px; padding: 12px; text-align: center; background: #f4f4f4; border-radius: 12px; font-weight: bold; font-size: 16px; }
    .rekap { margin-top: 10px; padding: 10px; background: #e9f7ff; border-radius: 12px; font-size: 14px; }
    .logout-btn { margin-top: 15px; background: red; color: #fff; }
    canvas { margin-top: 20px; max-height: 300px; }
    .footer {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 8px 12px; background: rgba(255,255,255,0.9);
      backdrop-filter: blur(6px); border-top: 1px solid #eaeaea;
      text-align: center; font-size: 12px; color: #444; z-index: 9999;
    }
    .footer a { color: inherit; text-decoration: none; font-weight: 600; }
    .footer a:hover { text-decoration: underline; }
    .filter-box { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }

    /* === Loading Spinner === */
    #loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      flex-direction: column;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid #ddd;
      border-top: 6px solid #4facfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Memuat aplikasi...</div>
  </div>

  <!-- Login Page -->
  <div class="container" id="loginPage" style="display:none;">
    <h2>ðŸ”‘ Silahkan Login</h2>
    <form id="loginForm">
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password : 1234" required>
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- App Page -->
  <div class="container" id="appPage" style="display:none;">
    <h2>ðŸ’° Catatan Keuangan</h2>
    <form id="form">
      <input type="text" id="deskripsi" placeholder="Deskripsi" required>
      <input type="number" id="jumlah" placeholder="Jumlah" required>
      <input type="date" id="tanggal" required>
      <select id="tipe">
        <option value="pemasukan">Pemasukan</option>
        <option value="pengeluaran">Pengeluaran</option>
        <option value="transfer">Transfer Bank ke Cash</option>
      </select>
      <select id="sumber">
        <option value="cash">Cash</option>
        <option value="saldo">Saldo Bank</option>
      </select>
      <button type="submit">Tambah</button>
    </form>

    <div class="filter-box">
      <input type="date" id="filterTanggal">
      <button onclick="lihatHari()">Lihat Hari</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Deskripsi</th>
          <th>Jumlah</th>
          <th>Tipe</th>
          <th>Sumber</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tabel-body"></tbody>
    </table>

    <div class="saldo-box" id="saldoCash">Saldo Cash: Rp 0</div>
    <div class="saldo-box" id="saldoBank">Saldo Bank: Rp 0</div>
    <div class="rekap" id="rekap-mingguan">Rekap Mingguan: Rp 0</div>
    <div class="rekap" id="rekap-bulanan">Rekap Bulanan: Rp 0</div>
    <div class="rekap" id="rekap-pengeluaran-cash">Total Pengeluaran Cash: Rp 0</div>
    <div class="rekap" id="rekap-pengeluaran-bank">Total Pengeluaran Bank: Rp 0</div>

    <canvas id="grafik"></canvas>
    <button id="downloadPDF">ðŸ“„ Download PDF</button>
    <button class="logout-btn" id="logout">Logout</button>
  </div>

  <footer class="footer">
    Â© <span id="year"></span> <a href="https://teajuskatess.id" target="_blank" rel="noopener">teajuskatess.id</a> â€” All rights reserved.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const loginPage = document.getElementById("loginPage");
    const appPage = document.getElementById("appPage");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logout");

    function showLogin() {
      loginPage.style.display = "block";
      appPage.style.display = "none";
    }
    function showApp() {
      loginPage.style.display = "none";
      appPage.style.display = "block";
      updateUI();
    }

    // Loading screen â†’ tentukan halaman tujuan
    window.addEventListener("load", () => {
      setTimeout(() => {
        document.getElementById("loading").style.display = "none";
        if(localStorage.getItem("loggedIn") === "true") {
          showApp();
        } else {
          showLogin();
        }
      }, 1000);
    });

    // Login
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      localStorage.setItem("loggedIn", "true");
      showApp();
    });
    // Logout
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("loggedIn");
      location.reload();
    });

    // ==================== Data Keuangan ====================
    const form = document.getElementById("form");
    const deskripsi = document.getElementById("deskripsi");
    const jumlah = document.getElementById("jumlah");
    const tanggal = document.getElementById("tanggal");
    const tipe = document.getElementById("tipe");
    const sumber = document.getElementById("sumber");
    const tabelBody = document.getElementById("tabel-body");
    const saldoCash = document.getElementById("saldoCash");
    const saldoBank = document.getElementById("saldoBank");
    const rekapMingguan = document.getElementById("rekap-mingguan");
    const rekapBulanan = document.getElementById("rekap-bulanan");
    const rekapPengeluaranCash = document.getElementById("rekap-pengeluaran-cash");
    const rekapPengeluaranBank = document.getElementById("rekap-pengeluaran-bank");
    const ctx = document.getElementById("grafik").getContext("2d");

    function getToday() { return new Date().toISOString().split("T")[0]; }
    function getKeyTanggal(tgl) { return "transaksi_" + tgl; }
    function loadTransaksi(tgl) { return JSON.parse(localStorage.getItem(getKeyTanggal(tgl))) || []; }
    function saveTransaksi(tgl, data) { localStorage.setItem(getKeyTanggal(tgl), JSON.stringify(data)); }

    let hariIni = getToday();
    let transaksi = loadTransaksi(hariIni);

    tanggal.value = hariIni;
    document.getElementById("filterTanggal").value = hariIni;

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const data = {
        id: Date.now(),
        desc: deskripsi.value,
        amount: parseInt(jumlah.value),
        type: tipe.value,
        source: sumber.value,
        date: new Date(tanggal.value).toISOString()
      };
      transaksi.push(data);
      saveTransaksi(hariIni, transaksi);
      updateUI();
      form.reset();
      tanggal.value = hariIni;
    });

    function hapusTransaksi(id) {
      transaksi = transaksi.filter(t => t.id !== id);
      saveTransaksi(hariIni, transaksi);
      updateUI();
    }

    function lihatHari() {
      const tgl = document.getElementById("filterTanggal").value;
      if(!tgl) return;
      transaksi = loadTransaksi(tgl);
      updateUI(tgl);
    }

    function updateUI(tgl = hariIni) {
      tabelBody.innerHTML = "";
      let cash = 0, bank = 0;
      let totalMinggu = 0, totalBulan = 0;
      let pengeluaranCash = 0, pengeluaranBank = 0;

      let semuaKunci = Object.keys(localStorage).filter(k => k.startsWith("transaksi_"));
      let semuaTransaksi = [];
      semuaKunci.forEach(k => {
        semuaTransaksi = semuaTransaksi.concat(JSON.parse(localStorage.getItem(k)));
      });

      const now = new Date();
      const awalMinggu = new Date(now); awalMinggu.setDate(now.getDate() - now.getDay());
      const awalBulan = new Date(now.getFullYear(), now.getMonth(), 1);

      semuaTransaksi.forEach(item => {
        if(item.type === "pemasukan") {
          if(item.source === "cash") cash += item.amount; else bank += item.amount;
        } else if(item.type === "pengeluaran") {
          if(item.source === "cash") { cash -= item.amount; pengeluaranCash += item.amount; }
          else { bank -= item.amount; pengeluaranBank += item.amount; }
        } else if(item.type === "transfer") {
          bank -= item.amount;
          cash += item.amount;
        }

        const d = new Date(item.date);
        if(d >= awalMinggu && d <= now && item.type !== "transfer") {
          totalMinggu += item.type === "pemasukan" ? item.amount : -item.amount;
        }
        if(d >= awalBulan && d <= now && item.type !== "transfer") {
          totalBulan += item.type === "pemasukan" ? item.amount : -item.amount;
        }
      });

      transaksi.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${new Date(item.date).toLocaleDateString("id-ID")}</td>
          <td>${item.desc}</td>
          <td class="${item.type === "pemasukan" ? "income" : item.type === "pengeluaran" ? "expense" : ""}">Rp ${item.amount.toLocaleString()}</td>
          <td>${item.type}</td>
          <td>${item.source}</td>
          <td><button onclick="hapusTransaksi(${item.id})">Hapus</button></td>
        `;
        tabelBody.appendChild(row);
      });

      saldoCash.textContent = "Saldo Cash: Rp " + cash.toLocaleString();
      saldoBank.textContent = "Saldo Bank: Rp " + bank.toLocaleString();
      rekapMingguan.textContent = "Rekap Mingguan: Rp " + totalMinggu.toLocaleString();
      rekapBulanan.textContent = "Rekap Bulanan: Rp " + totalBulan.toLocaleString();
      rekapPengeluaranCash.textContent = "Total Pengeluaran Cash: Rp " + pengeluaranCash.toLocaleString();
      rekapPengeluaranBank.textContent = "Total Pengeluaran Bank: Rp " + pengeluaranBank.toLocaleString();

      if(window.grafikChart) window.grafikChart.destroy();
      window.grafikChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Cash", "Bank"],
          datasets: [{ data: [cash, bank], backgroundColor: ["#4caf50", "#2196f3"] }]
        }
      });
    }

    document.getElementById("downloadPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Laporan Keuangan", 14, 20);

      let semuaKunci = Object.keys(localStorage).filter(k => k.startsWith("transaksi_"));
      let semuaTransaksi = [];
      semuaKunci.forEach(k => {
        semuaTransaksi = semuaTransaksi.concat(JSON.parse(localStorage.getItem(k)));
      });

      const body = semuaTransaksi.map(t => [
        new Date(t.date).toLocaleDateString("id-ID"),
        t.desc,
        "Rp " + t.amount.toLocaleString(),
        t.type,
        t.source
      ]);

      doc.autoTable({
        head: [["Tanggal", "Deskripsi", "Jumlah", "Tipe", "Sumber"]],
        body,
        startY: 30,
        theme: "grid",
      });

      let totalPemasukan = 0, totalPengeluaran = 0;
      let pemasukanCash = 0, pemasukanBank = 0;
      let pengeluaranCash = 0, pengeluaranBank = 0;
      let totalTransfer = 0;

      semuaTransaksi.forEach(t => {
        if(t.type === "pemasukan") {
          totalPemasukan += t.amount;
          if(t.source === "cash") pemasukanCash += t.amount;
          else pemasukanBank += t.amount;
        } else if(t.type === "pengeluaran") {
          totalPengeluaran += t.amount;
          if(t.source === "cash") pengeluaranCash += t.amount;
          else pengeluaranBank += t.amount;
        } else if(t.type === "transfer") {
          totalTransfer += t.amount;
        }
      });

      let y = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(12);
      doc.text("Rekapitulasi:", 14, y); y += 8;
      doc.text(`Total Pemasukan: Rp ${totalPemasukan.toLocaleString()}`, 20, y); y += 6;
      doc.text(`   - Cash: Rp ${pemasukanCash.toLocaleString()}`, 30, y); y += 6;
      doc.text(`   - Bank: Rp ${pemasukanBank.toLocaleString()}`, 30, y); y += 8;
      doc.text(`Total Pengeluaran: Rp ${totalPengeluaran.toLocaleString()}`, 20, y); y += 6;
      doc.text(`   - Cash: Rp ${pengeluaranCash.toLocaleString()}`, 30, y); y += 6;
      doc.text(`   - Bank: Rp ${pengeluaranBank.toLocaleString()}`, 30, y); y += 8;
      doc.text(`Total Transfer (Bank â†’ Cash): Rp ${totalTransfer.toLocaleString()}`, 20, y); y += 10;

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      doc.setFontSize(9);
      doc.text(`Â© ${new Date().getFullYear()} teajuskatess.id`, pageWidth / 2, pageHeight - 8, { align: "center" });

      doc.save("laporan_keuangan.pdf");
    });
  </script>
